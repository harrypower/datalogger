<!Doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Last 100 data chart</title>
</head>
<$
require ../collection/sqlite3-stuff.fs
require ../collection/svgmaker.fs
decimal

$>
<body>
<$

list$: data1
list$: data2
list$: dataattr1
list$: dataattr2
list$: datacirleattr1
list$: datacirleattr2

list$: xlabdata
list$: xlabtxtattr
list$: ylabtxtattr
list$: lablineattr

list$: textdata1
list$: textattr1
list$: textdata2
list$: textattr2

create mydata 2 chartdata% %size * allot 
create myattr chartattr% %allot drop
create mytexts 2 charttext% %size * allot

list$: tempdata$
variable tempdb$
bufr$: buffa$
bufr$: buffb$
bufr$: buffc$
: getlast100 ( caddr-colum u-colum caddr-table u-table -- data-xt )
    buffa$ 2swap buffb$ 2swap 
    { colum ucolum table utable }
    tempdata$-$off
    table utable max(rowid)$ buffc$
    setupsqlite3
    s" " dbrecordseparator 
    s" `" dbfieldseparator
    30000 mkretbuff
    s" select " tempdb$ $!
    colum ucolum tempdb$ $+! s"  from " tempdb$ $+!
    table utable tempdb$ $+!  s"  where row > " tempdb$ $+!
    s>number? true = if d>s 100 - #to$ tempdb$ $+! else true throw then
    s" ;" tempdb$ $+! 
    tempdb$ $@ dbcmds
    sendsqlite3cmd dberrorthrow 
    dbret$
    begin
	'`' $split
	2swap tempdata$-$!
	dup 0 = 
    until
    ['] tempdata$
;

s" (temperature * 0.1)" s" mbedA" getlast100 execute data1->$!
s" (humidity * 0.1)" s" mbedA" getlast100 execute data2->$!
s" datetime(dtime,'unixepoch','localtime')" s" mbedA" getlast100 execute xlabdata->$!
: looksee ( -- )
    data1 swap drop 0 ?do
	data1-$@ type ."  "  data2-$@ type ."  " xlabdata-$@ type ." ::  " 
    loop ;
\ looksee

: data-attr ( -- )
    dataattr1-$off
    s\" fill=\"white\""             dataattr1-$!
    s\" fill-opacity=\"0.0\""       dataattr1-$!
    s\" stroke=\"red\""             dataattr1-$!
    s\" stroke-opacity=\"1.0\""     dataattr1-$!
    s\" stroke-width=\"3.0\""       dataattr1-$!
    datacirleattr1-$off
    s\" fill=\"white\""             datacirleattr1-$!
    s\" fill-opacity=\"1.0\""       datacirleattr1-$!
    s\" stroke=\"red\""             datacirleattr1-$!
    s\" stroke-opacity=\"1.0\""     datacirleattr1-$!
    s\" stroke-width=\"3.0\""       datacirleattr1-$!
    dataattr2-$off
    s\" fill=\"white\""             dataattr2-$!
    s\" fill-opacity=\"0.0\""       dataattr2-$!
    s\" stroke=\"green\""           dataattr2-$!
    s\" stroke-opacity=\"1.0\""     dataattr2-$!
    s\" stroke-width=\"3.0\""       dataattr2-$!
    datacirleattr2-$off
    s\" fill=\"white\""             datacirleattr2-$!
    s\" fill-opacity=\"1.0\""       datacirleattr2-$!
    s\" stroke=\"green\""           datacirleattr2-$!
    s\" stroke-opacity=\"1.0\""     datacirleattr2-$!
    s\" stroke-width=\"3.0\""       datacirleattr2-$!
    ['] data1     mydata data-xt%      0 chartdata% %size * + !
    ['] dataattr1 mydata data-attr-xt% 0 chartdata% %size * + !
    ['] datacirleattr1 mydata circle-attr-xt% 0 chartdata% %size * + !
    ['] data2     mydata data-xt%      1 chartdata% %size * + !
    ['] dataattr2 mydata data-attr-xt% 1 chartdata% %size * + !
    ['] datacirleattr2 mydata circle-attr-xt% 1 chartdata% %size * + ! ;

: label-attr ( -- )
    xlabtxtattr-$off
    s\" fill=\"red\""              xlabtxtattr-$!
    s\" fill-opacity=\"0.7\""       xlabtxtattr-$!
    s\" fill-width=\"1.5\""         xlabtxtattr-$!
    s\" stroke=\"red\""            xlabtxtattr-$!
    s\" stroke-opacity=\"0.9\""     xlabtxtattr-$!
    s\" stroke-width=\"1.5\""       xlabtxtattr-$!
    s\" font-size=\"17px\""         xlabtxtattr-$!
    ylabtxtattr-$off
    s\" fill=\"blue\""               ylabtxtattr-$!
    s\" fill-opacity=\"0.7\""       ylabtxtattr-$!
    s\" fill-width=\"1.5\""         xlabtxtattr-$!
    s\" stroke=\"blue\""             ylabtxtattr-$!
    s\" stroke-opacity=\"1.0\""     ylabtxtattr-$!
    s\" stroke-width=\"1.5\""       ylabtxtattr-$!
    s\" font-size=\"18px\""         ylabtxtattr-$!
    lablineattr-$off
    s\" fill=\"black\""             lablineattr-$!
    s\" fill-opacity=\"0.0\""       lablineattr-$!
    s\" stroke=\"black\""           lablineattr-$!
    s\" stroke-opacity=\"1.0\""     lablineattr-$!
    s\" stroke-width=\"6.0\""       lablineattr-$!
    s\" stroke-linecap=\"round\""   lablineattr-$!
    ['] xlabdata    myattr xlable-data-xt% !
    ['] xlabtxtattr myattr xlabtxt-attr-xt% !
    ['] ylabtxtattr myattr ylabtxt-attr-xt% !
    ['] lablineattr myattr labline-attr-xt% ! ;

: charttext ( -- )
    textdata1-$off
    s" mbedA sensor Temperature last 100 readings " textdata1-$!
    textattr1-$off
    s\" fill=\"red\""               textattr1-$!
    s\" fill-opacity=\"0.7\""       textattr1-$!
    s\" fill-width=\"1.7\""         textattr1-$!
    s\" stroke=\"red\""             textattr1-$!
    s\" stroke-opacity=\"0.9\""      textattr1-$!
    s\" stroke-width=\"1.4\""       textattr1-$!
    s\" font-size=\"28px\""         textattr1-$!
    textdata2-$off
    s" mbedA sensor Humidity last 100 readings " textdata2-$!
    s\" fill=\"green\""             textattr2-$!
    s\" fill-opacity=\"0.7\""       textattr2-$!
    s\" fill-width=\"1.7\""         textattr2-$!
    s\" stroke=\"green\""           textattr2-$!
    s\" stroke-opacity=\"0.9\""      textattr2-$!
    s\" stroke-width=\"1.4\""       textattr2-$!
    s\" font-size=\"28px\""         textattr2-$!
    ['] textdata1 mytexts text-xt% 0 charttext% %size * + !
    xlablesize 100 + mytexts text-x% 0 charttext% %size * + !
    30  mytexts text-y% 0 charttext% %size * + !
    ['] textattr1 mytexts text-attr-xt% 0 charttext% %size * + !  
    ['] textdata2 mytexts text-xt% 1 charttext% %size * + !
    xlablesize 100 + mytexts text-x% 1 charttext% %size * + !
    70  mytexts text-y% 1 charttext% %size * + !
    ['] textattr2 mytexts text-attr-xt% 1 charttext% %size * + ! ;

90 to xlablerot
0 to ylablerot
4 to circleradius
2000 to xmaxchart
300 to ylablesize
100 to ytoplablesize
data-attr label-attr charttext
mytexts 2 myattr  mydata 2 makesvgchart false = [if] type [else] 2drop [then]

$>

</body>
</html>
