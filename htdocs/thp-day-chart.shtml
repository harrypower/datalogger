<!DOCTYPE html>
<HTML>
<HEAD>  
<meta charset="utf-8">
<TITLE>Day THP data Charts</TITLE>  
</HEAD>  
<BODY>  

<$
 
include ../string.fs
include ../Gforth-Tools/sqlite3_gforth_lib.fs
decimal

variable datalogger_path$
variable dbpath$
variable junks$
variable presql$
variable postsql$
variable lablesnow$
variable datanow$
variable lablesday$
variable minday$
variable maxday$
variable minhumdday$
variable maxhumdday$
variable minpresday$
variable maxpresday$
variable datenow$
0 value starthour 
0 value startyear
0 value startday
0 value startmonth


s" /var/lib/datalogger-gforth/datalogger_home_path" slurp-file datalogger_path$ $!
s" /collection/sensordb.data" datalogger_path$ $@ junks$ $! junks$ $+!
junks$ $@ dbname
junks$ $@ dbpath$ $!


: dto$ ( d -- caddr u )  \ convert double signed to a string
    swap over dabs <<# #s rot sign #> #>> ;

: nextcomma ( caddr u -- caddr1 u1 nflag ) \ nflag is true if next comma is found and caddr u contains the string past that comma
    s" ," search if
	swap 1 + swap 1 - true
    then ;

: #uptocomma { caddr u -- d nflag } \ nflag is true is d is the number from string before a comma
    caddr u s" ," search if
	swap drop u swap - caddr swap s>number?
    else
	0 0 false
    then ;

: #pastxcomma { caddr u n#comma -- d nflag } \ nflag is true if n#comma is found and a number d can be extracted from it
    try
	n#comma 0 ?do
	    caddr u nextcomma if to u to caddr else 1 throw then
	loop
	caddr u #uptocomma
    restore 1 = if 0 0 false else true then
    endtry ;

: $pastxcomma { caddr u n#comma -- caddr1 u1 nflag } \ nflag is true if n#comma is found .. the caddr1 u1 will contain the string before that last comma
    try
	n#comma 0 ?do
	    caddr u nextcomma if to u to caddr else 1 throw then
	loop
	caddr u 2dup nextcomma if swap drop 1 + - else 2drop 2 - then
	true
    restore 1 = if 0 0 false else true then
    endtry ;


s" " dbrecordseparator

10000 mkretbuff

: getdate ( -- )
    s" ," dbfieldseparator
    s" select date(dtime,'unixepoch','localtime') from thpdata limit 1 offset ((select max(rowid) from thpdata) -1);" dbcmds
    sendsqlite3cmd drop dbret$ 1 - datenow$ $! ;
 
: isnull? ( caddr u -- caddr1 u1 ) \ look for "NULL," in the string and if not found return string but if found return ","
    2dup s" NULL," search if 2drop 2drop s" ," else 2drop then ; 

: add0$ ( caddr u -- caddr1 u1 ) \ simply adds a "0" to begining of sting if string caddr u only contains one char at entry
    dup 1 = if s" 0" pad $! pad $+! pad $@ then ;

: getnowlables
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select strftime('%H',dtime,'unixepoch','localtime') from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - lablesday$ $! ;

: getnowmin
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((min(DTHtemperature)/10)+((min(DTHtemperature)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - minday$ $! ;
: getnowmax
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((max(DTHtemperature)/10)+((max(DTHtemperature)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - maxday$ $! ;
: gethumdnowmin
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((min(DTHhumd)/10)+((min(DTHhumd)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - minhumdday$ $! ;

: gethumdnowmax
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((max(DTHhumd)/10)+((max(DTHhumd)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - maxhumdday$ $! ;
: getpresnowmin
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((min(BMPpressure)/10)+((min(BMPpressure)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - minpresday$ $! ;

: getpresnowmax
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((max(BMPpressure)/10)+((max(BMPpressure)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - maxpresday$ $! ;

getnowlables
getnowmin
getnowmax
gethumdnowmin
gethumdnowmax
getpresnowmin
getpresnowmax
getdate
$>

<script src="../chart/Chart.js"></script>
<canvas id="tempChart" width=1000" height="300"></canvas>

<script>

  var tempoptions = { 'pointDotRadius':2 , scaleFontColor : "#572", scaleFontFamily : "'Comic Sans MS'", scaleFontStyle : "bold" };
  var tempdata = {
  labels : [ <$ lablesday$ $@ type $> ],
    datasets : [
    {
    fillColor : "rgba(120,220,250,0.5)",
    strokeColor : "rgba(220,220,220,1)",
    pointColor : "rgba(220,220,220,1)",
    pointStrokeColor : "#fff",
    data : [ <$ minday$ $@ type $> ]
      },
      {
      fillColor : "rgba(151,187,205,0.5)",
      strokeColor : "rgba(151,187,205,1)",
      pointColor : "rgba(151,187,205,1)",
      pointStrokeColor : "#fff",
      data : [ <$ maxday$ $@ type $> ]
        }
	]
	}
	
	//Get the context of the canvas element we want to select
	var tempctx = document.getElementById("tempChart").getContext("2d");
 	var mytempChart = new Chart(tempctx).Line(tempdata,tempoptions);

	setTimeout(function(){
	tempctx.fillStyle="#572";
	tempctx.font="30px Comic Sans MS";
	tempctx.fillText('Temperature min max for <$ datenow$ $@ type $> ',700,20);
	  tempctx.fillStyle="red";
	  tempctx.font="15px Comic Sans MS";  
          tempctx.fillText('C',50 ,230);
	  tempctx.fillText('Hours',130,260);
          tempctx.beginPath();
          tempctx.moveTo(50,220);
          tempctx.lineTo(50,180);
          tempctx.moveTo(40,200);
          tempctx.lineTo(50,180);
          tempctx.moveTo(140,260);
          tempctx.lineTo(200,260);
          tempctx.moveTo(190,270);
          tempctx.lineTo(200,260);
          tempctx.strokeStyle="red";
          tempctx.stroke();
	}, 2000);
</script>
	    
<canvas id="humdChart" width=1000" height="300"></canvas>

<script>
  var humdoptions = { 'pointDotRadius':2 , scaleFontColor : "#572", scaleFontFamily : "'Comic Sans MS'", scaleFontStyle : "bold" };
  var humddata = {
  labels : [ <$ lablesday$ $@ type $> ],
    datasets : [
    {
    fillColor : "rgba(120,220,250,0.5)",
    strokeColor : "rgba(220,220,220,1)",
    pointColor : "rgba(220,220,220,1)",
    pointStrokeColor : "#fff",
    data : [ <$ minhumdday$ $@ type $> ]
      },
      {
      fillColor : "rgba(151,187,205,0.5)",
      strokeColor : "rgba(151,187,205,1)",
      pointColor : "rgba(151,187,205,1)",
      pointStrokeColor : "#fff",
      data : [ <$ maxhumdday$ $@ type $> ]
	}
	]
	}
	
	//Get the context of the canvas element we want to select
	var humdctx = document.getElementById("humdChart").getContext("2d");
	var myhumdChart = new Chart(humdctx).Line(humddata,humdoptions);

        setTimeout(function(){
        humdctx.fillStyle="#572";
        humdctx.font="30px Comic Sans MS";
        humdctx.fillText('Relative Humidity min max for <$ datenow$ $@ type $> ',750,20);
          humdctx.fillStyle="red";
	  humdctx.font="15px Comic Sans MS";
          humdctx.fillText('% rH',90 ,230);
          humdctx.fillText('Hours',130,260);
          humdctx.beginPath();
          humdctx.moveTo(70,220);
          humdctx.lineTo(70,180);
          humdctx.moveTo(60,200);
          humdctx.lineTo(70,180);
          humdctx.moveTo(140,260);
          humdctx.lineTo(200,260);
          humdctx.moveTo(190,270);
          humdctx.lineTo(200,260);
          humdctx.strokeStyle="red";
          humdctx.stroke();
        }, 2000);
</script>
	    
<canvas id="pressureforthChart" width=1000" height="300"></canvas>

<script>
  var pressoptions = { 'pointDotRadius':2 , scaleFontColor : "#572", scaleFontFamily : "'Comic Sans MS'", scaleFontStyle : "bold" };
  var pressuredata = {
  labels : [ <$ lablesday$ $@ type $> ],
  datasets : [
  {
  fillColor : "rgba(120,220,250,0.5)",
  strokeColor : "rgba(220,220,220,1)",
  pointColor : "rgba(220,220,220,1)",
  pointStrokeColor : "#fff",
  data : [ <$ minpresday$ $@ type $> ]
    },
    {
    fillColor : "rgba(151,187,205,0.5)",
    strokeColor : "rgba(151,187,205,1)",
    pointColor : "rgba(151,187,205,1)",
    pointStrokeColor : "#fff",
    data : [ <$ maxpresday$ $@ type $> ]
      }
      ]
      }
	
	//Get the context of the canvas element we want to select
	var pressurectx = document.getElementById("pressureforthChart").getContext("2d");
	var mypressChart = new Chart(pressurectx).Line(pressuredata,pressoptions);
	
        setTimeout(function(){
        pressurectx.fillStyle="#572";
        pressurectx.font="30px Comic Sans MS";
        pressurectx.fillText('Barometric Pressure min max for <$ datenow$ $@ type $> ',750,20);
          pressurectx.fillStyle="red";
          pressurectx.font="15px Comic Sans MS";
          pressurectx.fillText('pa',90 ,230);
          pressurectx.fillText('Hours',130,260);
	  pressurectx.beginPath();
	  pressurectx.moveTo(80,220);
	  pressurectx.lineTo(80,180);
	  pressurectx.moveTo(70,200);
	  pressurectx.lineTo(80,180);
	  pressurectx.moveTo(140,260);
	  pressurectx.lineTo(200,260);
	  pressurectx.moveTo(190,270);
	  pressurectx.lineTo(200,260);
	  pressurectx.strokeStyle="red";
	  pressurectx.stroke();
        }, 2000);

</script>

<$ url-args $@ s" testt" search swap drop swap drop 
[if]
    : gettest ( -- caddr u )
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((max(DTHtemperature)/10)+((max(DTHtemperature)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-87000 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$  ;

   s" <h3>minday$: " type
   minday$ $@ type s" </h3><br>" type
   s" <h3>maxday$: " type
   maxday$ $@ type s" </h3><br>" type
   gettest
   dberrmsg s" <h3>error#: " type . s"  $:" type type s" </h3><br>" type
   s" <h3>rereading: " type type s" </h3><br>" type 

[then]
$>

</BODY>  
</HTML>

