<!DOCTYPE html>
<HTML>
<HEAD>  
<meta charset="utf-8">
<TITLE>Temperature Charting</TITLE>  
</HEAD>  
<BODY>  

<$
 
include ../string.fs
include ../Gforth-Tools/sqlite3_gforth_lib.fs
decimal

variable datalogger_path$
variable dbpath$
variable junks$
variable presql$
variable postsql$
0 value starthour 
0 value startyear
0 value startday
0 value startmonth


s" /var/lib/datalogger-gforth/datalogger_home_path" slurp-file datalogger_path$ $!
s" /collection/sensordb.data" datalogger_path$ $@ junks$ $! junks$ $+!
junks$ $@ dbname
junks$ $@ dbpath$ $!


: dto$ ( d -- caddr u )  \ convert double signed to a string
    swap over dabs <<# #s rot sign #> #>> ;

: nextcomma ( caddr u -- caddr1 u1 nflag ) \ nflag is true if next comma is found and caddr u contains the string past that comma
    s" ," search if
	swap 1 + swap 1 - true
    then ;

: #uptocomma { caddr u -- d nflag } \ nflag is true is d is the number from string before a comma
    caddr u s" ," search if
	swap drop u swap - caddr swap s>number?
    else
	0 0 false
    then ;

: #pastxcomma { caddr u n#comma -- d nflag } \ nflag is true if n#comma is found and a number d can be extracted from it
    try
	n#comma 0 ?do
	    caddr u nextcomma if to u to caddr else 1 throw then
	loop
	caddr u #uptocomma
    restore 1 = if 0 0 false else true then
    endtry ;

: $pastxcomma { caddr u n#comma -- caddr1 u1 nflag } \ nflag is true if n#comma is found .. the caddr1 u1 will contain the string before that last comma
    try
	n#comma 0 ?do
	    caddr u nextcomma if to u to caddr else 1 throw then
	loop
	caddr u 2dup nextcomma if swap drop 1 + - else 2drop 2 - then
	true
    restore 1 = if 0 0 false else true then
    endtry ;


s" " dbrecordseparator

10000 mkretbuff

: getlables ( -- caddr u )
    s\" \",\"" dbfieldseparator
    s" select datetime(dtime,'unixepoch','localtime') from thpdata limit 50 offset ((select max(rowid) from thpdata) -50);" dbcmds
    sendsqlite3cmd drop dbret$ 2 -
    s\" \"" junks$ $! junks$ $+! junks$ $@ ;
 
: getdata ( -- caddr u )
    s" ," dbfieldseparator
    s" select ((DTHtemperature / 10)+((DTHtemperature % 10)*0.1)) from thpdata limit 50 offset ((select max(rowid) from thpdata) -50);" dbcmds
    sendsqlite3cmd drop dbret$ 1 -  ;

: getstarttimes ( -- caddr u )
    s" ," dbfieldseparator
    s" select strftime('%H',dtime,'unixepoch','localtime'), strftime('%Y',dtime,'unixepoch','localtime'), " junks$ $!
    s" strftime('%m',dtime,'unixepoch','localtime'), strftime('%d',dtime,'unixepoch','localtime') " junks$ $+!
    s" from thpdata limit 1 offset ((select max(rowid) from thpdata)-1);" junks$ $+!
    junks$ $@ dbcmds
    sendsqlite3cmd drop
    dbret$ 0 #pastxcomma drop d>s to starthour
    dbret$ 1 #pastxcomma drop d>s to startyear
    dbret$ 2 #pastxcomma drop d>s to startmonth
    dbret$ 3 #pastxcomma drop d>s to startday ;

: isnull? ( caddr u -- caddr1 u1 ) \ look for "NULL," in the string and if not found return string but if found return ","
    2dup s" NULL," search if 2drop 2drop s" ," else 2drop then ; 

: add0$ ( caddr u -- caddr1 u1 ) \ simply adds a "0" to begining of sting if string caddr u only contains one char at entry
    dup 1 = if s" 0" pad $! pad $+! pad $@ then ;

: getnowlables
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select strftime('%H',dtime,'unixepoch','localtime') from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-86400 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - ;

: getnowmin
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((min(DTHtemperature)/10)+((min(DTHtemperature)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-86400 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') having min(DTHtemperature) order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - ;
: getnowmax
    s" ," dbfieldseparator
    s" " dbrecordseparator
    1000 mkretbuff
    s" select ((max(DTHtemperature)/10)+((max(DTHtemperature)%10)*0.1)) from thpdata where " presql$ $!
    s" (dtime > strftime('%s','now','-86400 seconds')) " presql$ $+!
    s" group by strftime('%Y%m%d%H',dtime,'unixepoch','localtime') having max(DTHtemperature) order by dtime ; " presql$ $+!
    presql$ $@ dbcmds sendsqlite3cmd drop
    dbret$ 1 - ;

$>

<script src="../chart/Chart.js"></script>
<canvas id="gforthChart" width=1500" height="400"></canvas>

<script>

var options = { 'pointDotRadius':2 };

var gforthdata = {
	labels : [ <$ getlables type $> ],
	datasets : [
		{
			fillColor : "rgba(120,220,250,0.5)",
			strokeColor : "rgba(220,220,220,1)",
			pointColor : "rgba(220,220,220,1)",
			pointStrokeColor : "#fff",
			data : [ <$ getdata type $> ]
		}
	]
}

//Get the context of the canvas element we want to select
var gforthctx = document.getElementById("gforthChart").getContext("2d");
var mygforthChart = new Chart(gforthctx).Line(gforthdata,options);

</script>

<script src="../chart/Chart.js"></script>
<canvas id="secondgforthChart" width=1000" height="400"></canvas>

<script>

var options = { 'pointDotRadius':2 };
var gforthdata = {
labels : [ <$ getnowlables type $> ],
datasets : [
	{
	fillColor : "rgba(120,220,250,0.5)",
	strokeColor : "rgba(220,220,220,1)",
	pointColor : "rgba(220,220,220,1)",
	pointStrokeColor : "#fff",
	data : [ <$ getnowmin type $> ]
    },
    {
    fillColor : "rgba(151,187,205,0.5)",
    strokeColor : "rgba(151,187,205,1)",
    pointColor : "rgba(151,187,205,1)",
    pointStrokeColor : "#fff",
    data : [ <$ getnowmax type $> ]
                    }
	]
	}

//Get the context of the canvas element we want to select
var gforthctx = document.getElementById("secondgforthChart").getContext("2d");
var mygforthChart = new Chart(gforthctx).Line(gforthdata,options);

</script>
	    
    
<select name="month" form="month">
<option value="1">Jan</option>
<option value="2">Feb</option>
</select>
<form action="thp-day-chart.shtml" method="post" id=">
<input type="submit" value="Select the day you want to view!"></form>

<p>Posted message is: <$ active @ [if] posted $@ type [else] s" nothing posted!" type [then] $> </p>

<p> lables: <$ getnowlables type $> </p>
<p> min: <$ getnowmin type $> </p>
<p> max: <$ getnowmax type $> </p>
</BODY>  
</HTML>

