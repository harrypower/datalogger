<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Errors list</title>
</head>
<$
require string.fs
require ../Gforth-Tools/sqlite3_gforth_lib.fs
decimal

variable datalogger_path$
variable dbpath$
variable junks$
variable presql$

s" /var/lib/datalogger-gforth/datalogger_home_path" slurp-file datalogger_path$ $!
s" /collection/sensordb.data" datalogger_path$ $@ junks$ $! junks$ $+!
junks$ $@ dbname
junks$ $@ dbpath$ $!

\ s" </td><td>" dbfieldseparator
\ s" </td></tr><tr><td>" dbrecordseparator
\ 5000 mkretbuff

: #uptocomma { caddr u -- d nflag } \ nflag is true is d is the number from string before a comma
    caddr u s" ," search if
        swap drop u swap - caddr swap s>number?
    else
        0 0 false
    then ;

: issuedbcmds ( -- caddr u nerror ) \ nerror is false if db query is ok
    sendsqlite3cmd \ if nerror is not false caddr u will contain the error otherwise it is the sqlite3 message
    if
        5 ms sendsqlite3cmd
        if
            10 ms sendsqlite3cmd drop
        then
    then
    dberrmsg
    dup false = if
        swap drop swap drop dbret$ rot
    then ;

: totalerrors ( -- dmaxerrors nerror )
    s" ," dbfieldseparator
    s\" \n" dbrecordseparator
    5000 mkretbuff
    s" select max(row) from errors;" dbcmds
    issuedbcmds if
        2drop 0 0 dberrmsg -rot 2drop
    else
        #uptocomma
    then ;

: getrows
   s" </td><td>" dbfieldseparator
   s" </td></tr><tr><td>" dbrecordseparator
   5000 mkretbuff
    s" select datetime(errors.dtime,'unixepoch','localtime'),errors.error,errorList.errorText from errors inner join errorList on errors.error=errorList.error " presql$ $!
   s"  limit 15 offset ((select max(rowid) from errors) -15);" presql$ $+! presql$ $@
   dbcmds sendsqlite3cmd dbret$ type ;

: notvalidmsg ( -- )
    s" not valid or unavailable!" type ;

$>
<body>
<h1>List of last 15 logging errors</h1>
    <table cellspacing="20">
    <tr> <td>Date</td><td>Error #</td><td>Error Message</td><td></td></tr>
<tr> <td>
<$ getrows $> </td> <td></td><td></td><td></td></tr>
</table>
<h1><p>Total errors <$ totalerrors [if]  d. [else] notvalidmsg 2drop [then] $> </p></h1>    
</body>
</html>
