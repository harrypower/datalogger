<!DOCTYPE html>
<HTML>
<HEAD>
<meta charset="utf-8">
<TITLE>Temperature and Humidity</TITLE>
</HEAD>
<$ 
include ../string.fs
include ../collection/dth11.fs
include ../collection/script.fs

warnings off

0 value fileid
false value local_data_valid
variable webview_name$
variable data_store$
variable junk$

junk$ $init
data_store$ $init
s" /home/pi/git/datalogger/collection/logged_events.data" data_store$ $!
webview_name$ $init
s" /home/pi/git/datalogger/htdocs/logged.data" webview_name$ $!

: getlocaldata ( -- nflag ) \ if false is returned then no logged data is present.  True means log data present and was transfered for use localy
    TRY
	s" test -e " junk$ $! data_store$ $@ junk$ $+! s"  && echo 'yes' || echo 'no'" junk$ $+! junk$ $@ shget throw s" yes" search
	if drop drop 
	    s" sudo cp /home/pi/git/datalogger/collection/logged_events.data /home/pi/git/datalogger/htdocs/logged.data" system $? throw
	    s" sudo cp /home/pi/git/datalogger/htdocs/logged.data /home/pi/git/datalogger/htdocs/logged.csv" system $? throw
	    s" sudo cp /home/pi/git/datalogger/htdocs/logged.data /home/pi/git/datalogger/htdocs/logged.txt" system $? throw
	    false
	else
	    drop drop true
	then
    RESTORE if false else true then 
    ENDTRY
    ;

: gettemp ( -- ntemp nhumd ) begin dth11_parse if drop drop false else true then 2000 ms  until ;
: enumerate_data ( -- udatapoints ) 
    TRY webview_name$ $@ r/o open-file throw to fileid fileid file-size throw fileid close-file throw false
    RESTORE if 0 s>d dabs then 
    ENDTRY ;  
: logging_size ( -- usize ) 
    TRY s" /home/pi/git/datalogging/collection/logginglastmsg.data" r/o open-file throw to fileid fileid file-size throw fileid close-file throw false
    RESTORE if 0 s>d dabs then 
    ENDTRY
;

$>

<BODY>

<h1><p> <$  gettemp  s" The current temperature is " type u. s" <br>The current relative humidity is " type u. $> </p></h1> 
<$ getlocaldata to local_data_valid local_data_valid [if] s\"  <form action=\"logged_data_table.shtml\" method=\"post\"><input type=\"submit\" value=\"View Table of logged temperature and humidity data!\"></form>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.txt\">View Logged temperature and humidity data as text file!</a> <br>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.csv\">Download Logged temperature and humidity data as csv file!</a><br>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.data\">Download Logged temperature and humidity data as a text file with a .data extention!</a>" type [then] $>
<p> Logged file size is <$ local_data_valid [if] enumerate_data ud. [else] s" is not available!" type [then] $> </p>
<p> Gforth version is <$ version-string type $> </p>
<p> Data present <$ local_data_valid [if] s" yes!" type  [else] s" no!" type [then] $> </p>
<p> Logging error size is <$ logging_size ud. $> </p>
</BODY>
</HTML>
