<!DOCTYPE html>
<HTML>
<HEAD>
<meta charset="utf-8">
<TITLE>Temperature and Humidity</TITLE>
</HEAD>
<$ 
include ../string.fs
include ../collection/script.fs
\ include ../collection/cad-sensor.fs

warnings off

0 value fileid
false value local_data_valid
variable datalogger_path$ 
variable webview_name$
variable webview_csv$
variable webview_txt$
variable data_store$
variable junk$
0 value ntemp
0 value nhumd
0 value nflag_temp_valid

junk$ $init
s" /var/lib/datalogger-gforth/datalogger_home_path" slurp-file datalogger_path$ $!
datalogger_path$ $@ data_store$ $! s" /collection/logged_events.data" data_store$ $+!
datalogger_path$ $@ webview_name$ $! s" /htdocs/logged.data" webview_name$ $+!
datalogger_path$ $@ webview_csv$ $! s" /htdocs/logged.csv" webview_csv$ $+!
datalogger_path$ $@ webview_txt$ $! s" /htdocs/logged.txt" webview_txt$ $+!

: getlocaldata ( -- nflag ) \ if false is returned then no logged data is present.  True means log data present and was transfered for use localy
    TRY
	s" test -e " junk$ $! data_store$ $@ junk$ $+! s"  && echo 'yes' || echo 'no'" junk$ $+! junk$ $@ shget throw s" yes" search
	if drop drop 
            s" sudo cp " junk$ $! data_store$ $@ junk$ $+! s"  " junk$ $+! webview_name$ $@ junk$ $+! junk$ $@ system $? throw  
	    s" sudo cp " junk$ $! data_store$ $@ junk$ $+! s"  " junk$ $+! webview_csv$ $@ junk$ $+! junk$ $@ system $? throw
            s" sudo cp " junk$ $! data_store$ $@ junk$ $+! s"  " junk$ $+! webview_txt$ $@ junk$ $+! junk$ $@ system $? throw 
	    false
	else
	    drop drop true
	then
    RESTORE if false else true then 
    ENDTRY
    ;

: gettemp ( -- nhumd ntemp nflag ) \ true returned for nflag means data is not valid false means humd and temp data is valid
    try
	0 0 0 s" sudo " junk$ $! datalogger_path$ $@ junk$ $+! s" /gpio/dth_11_22.fs -11_24" junk$ $+! junk$ $@ shget throw { nflag ntemp nhumd caddr u }
	caddr u s>number? throw d>s to nflag caddr u s"  " search
	if to u 1 + to caddr caddr u s>number? throw d>s to ntemp caddr u s"  " search
	    if swap 1 + swap s>number? throw d>s to nhumd else true throw then
	else true throw
	then
	false
    restore if 0 0 true else nhumd ntemp nflag then
    endtry ;

: gettemp2 ( -- nhumd ntemp nflag ) \ true is no good  false is ok data from dth22 sensor
    try
        0 0 0 s" sudo " junk$ $! datalogger_path$ $@ junk$ $+! s" /gpio/dth_11_22.fs -22_25" junk$ $+! junk$ $@ shget throw { nflag ntemp nhumd caddr u }
        caddr u s>number? throw d>s to nflag caddr u s"  " search
        if to u 1 + to caddr caddr u s>number? throw d>s to ntemp caddr u s"  " search
            if swap 1 + swap s>number? throw d>s to nhumd else true throw then
        else true throw
        then
        false
    restore if 0 0 true else nhumd ntemp nflag then
    endtry ;

: enumerate_data ( -- udatapoints ) 
    TRY webview_name$ $@ r/o open-file throw to fileid fileid file-size throw fileid close-file throw false
    RESTORE if 0 s>d dabs then 
    ENDTRY ;  
: logging_size ( -- usize ) 
    TRY datalogger_path$ $@ junk$ $! s" /collection/logginglastmsg.data" junk$ $+! junk$ $@ r/o open-file throw to fileid fileid file-size throw fileid close-file throw false
    RESTORE if 0 s>d dabs then 
    ENDTRY
;

: get-CdS ( -- ncad nflag )
    try
        
	s" sudo " junk$ $! datalogger_path$ $@ junk$ $+! s" /gpio/cadmium-sensor.fs 7" junk$ $+! junk$ $@ shget throw
	0 0 { caddr u nvalue nflag } caddr u s>number? throw d>s to nflag 
	caddr u s"  " search if to u 1 + to caddr caddr u s>number? throw d>s to nvalue else true throw then  
	false 
    restore if 0 true else nvalue nflag then 
    endtry ;

$>

<BODY>

<h1><p> <$ gettemp to nflag_temp_valid to ntemp to nhumd s" The current temperature is (dth11) " type nflag_temp_valid 0= [if] ntemp . [else] s" not available now!" type [then]
s" <br>The current relative humidity is (dth11) "  type nflag_temp_valid 0= [if] nhumd . [else] s" not avaiable now!" type [then] $> </p></h1> 
<h1><p> <$ gettemp2 to nflag_temp_valid to ntemp to nhumd s" The current temperature is (dth22) " type nflag_temp_valid 0= [if] ntemp . [else] s" not available now!" type [then]
s" <br>The current relative humidity is (dth22) "  type nflag_temp_valid 0= [if] nhumd . [else] s" not avaiable now!" type [then] $> </p></h1>
<h1><p>The light level on pin 7 is currently:  <$ get-CdS [if] s" not avaiable now!" type [else] . [then] $> </p></h1> 

<$ getlocaldata to local_data_valid local_data_valid [if] s\"  <form action=\"logged_data_table.shtml\" method=\"post\"><input type=\"submit\" value=\"View Table of logged temperature and humidity data!\"></form>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.txt\">View Logged temperature and humidity data as text file!</a> <br>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.csv\">Download Logged temperature and humidity data as csv file!</a><br>" type [then] $>
<$ local_data_valid [if] s\" <a href=\"logged.data\">Download Logged temperature and humidity data as a text file with a .data extention!</a>" type [then] $>
<p> Logged file size is <$ local_data_valid [if] enumerate_data ud. [else] s" is not available!" type [then] $> </p>
<p> Gforth version is <$ version-string type $> </p>
<p> Data present <$ local_data_valid [if] s" yes!" type  [else] s" no!" type [then] $> </p>
<p> Logging error size is <$ logging_size ud. $> </p>
<p> path is <$ data_store$ $@ type $> </p>
<p> webpath is <$ webview_name$ $@ type $> </p>
<p> fpath is <$ fpath .path $> </p>

</BODY>
</HTML>
