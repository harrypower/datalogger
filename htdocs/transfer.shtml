<html>
<head>
<title>Test data download</title>
<$
include ../string.fs
include ../collection/script.fs
include ../Gforth-Tools/sqlite3_gforth_lib.fs
decimal

variable datalogger_path$
variable dbpath$
variable dbtemppath$
variable junks$
variable junk$
0 value fid

s" /var/lib/datalogger-gforth/datalogger_home_path" slurp-file datalogger_path$ $!
s" /collection/sensordb.data" datalogger_path$ $@ junks$ $! junks$ $+!
junks$ $@ dbpath$ $!
datalogger_path$ $@ junks$ $! s" /htdocs/logged.data" junks$ $+! 
junks$ $@ dbtemppath$ $!

s" ," dbfieldseparator
s\" \r\n" dbrecordseparator
dbpath$ $@ dbname
30000 mkretbuff


: filetest ( caddr u -- nflag )  \ looks for the full path and file name in string and returns true if found
    s" test -e " junk$ $! junk$ $+! s"  && echo 'yes' || echo 'no'" junk$ $+! junk$ $@ shget throw 1 -  s" yes" compare  
    if false
    else true
    then ;

: getdata ( -- caddr u )
    s" select row,dtime,DTHtemperature,DTHhumd,BMPpressure from thpdata  "
   junks$ $!
   s"  limit 300 offset ((select max(rowid) from thpdata) -300);" junks$ $+! junks$ $@
   dbcmds sendsqlite3cmd drop dbret$  ;

: savedata ( caddr u -- )
   dbtemppath$ $@ filetest
   if dbtemppath$ $@ w/o open-file throw
   else dbtemppath$ $@ w/o create-file throw
   then to fid
   fid write-file throw
   fid flush-file throw
   fid close-file throw ;
getdata
savedata

$>

<script type="text/javascript">
window.onload=function(){
window.open('logged.data', 'Download', 'height=100,width=200' )
}
</script>
</head>
<body>
<a href="main.shtml">Back to Main</a>
</body>
</html>
